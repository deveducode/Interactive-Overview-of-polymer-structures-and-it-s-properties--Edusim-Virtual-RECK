<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Interactive virtual laboratory for exploring polymer structures and properties">
    <meta name="theme-color" content="#3b82f6">
    <title>Virtual Lab: Polymer Structure and Properties</title>
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
            --transition-standard: all 0.3s ease;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Navigation Styles */
        .nav-link { 
            transition: var(--transition-standard); 
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }
        .nav-link:hover { background-color: rgba(59, 130, 246, 0.1); }
        .nav-link.active {
            background-color: rgba(59, 130, 246, 0.2); 
            color: var(--primary-dark);
        }
        .nav-link.active::after {
            content: ''; 
            position: absolute; 
            right: 0; 
            top: 0; 
            height: 100%; 
            width: 4px;
            background-color: var(--primary); 
            border-radius: 4px 0 0 4px;
        }

        /* Simulation Container */
        .simulation-container {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-radius: 12px; 
            overflow: hidden; 
            background: white;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Tooltip */
        .tooltip {
            position: absolute; 
            background: rgba(30, 41, 59, 0.9); 
            color: white;
            padding: 8px 12px; 
            border-radius: 6px; 
            font-size: 0.85rem; 
            max-width: 250px;
            z-index: 1000; 
            pointer-events: none; 
            opacity: 0; 
            transition: var(--transition-standard);
            transform: translateY(10px);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        /* Property Cards */
        .property-card { 
            transition: var(--transition-standard); 
            will-change: transform;
            cursor: pointer;
        }
        .property-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .property-card button {
            transition: var(--transition-standard);
        }
        .property-card button:hover {
            transform: scale(1.05);
        }

        /* Quiz Options */
        .quiz-option {
            transition: all 0.2s ease;
            user-select: none;
            cursor: pointer;
            position: relative;
            font-size: 1rem;
            color: #374151;
        }
        .quiz-option:hover:not(:disabled) {
            background-color: rgba(59, 130, 246, 0.05);
            border-color: var(--primary);
        }
        .quiz-option.selected {
            border-color: var(--primary);
            background-color: rgba(59, 130, 246, 0.1);
            font-weight: 500;
        }
        .quiz-option.correct {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #10b981;
            color: #065f46;
        }
        .quiz-option.incorrect {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #991b1b;
        }
        .quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        .quiz-option.correct::after {
            content: '✓';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981;
            font-weight: bold;
            font-size: 1.2rem;
        }
        .quiz-option.incorrect::after {
            content: '×';
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #ef4444;
            font-weight: bold;
            font-size: 1.5rem;
        }
        .quiz-option.selected:not(.correct):not(.incorrect) {
            border-color: var(--primary);
            background-color: rgba(59, 130, 246, 0.1);
        }

        /* Progress Bar */
        .progress-bar { 
            height: 6px; 
            background-color: #e2e8f0; 
            border-radius: 3px; 
            overflow: hidden;
        }
        .progress-fill { 
            height: 100%; 
            background-color: var(--primary); 
            width: 30%; 
            transition: width 0.5s ease;
            transform: translateZ(0);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        .polymer-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 2rem;
        }
        .monomer {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            animation: polymerAnim 1.5s infinite ease-in-out;
        }
        @keyframes polymerAnim {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .monomer:nth-child(1) { animation-delay: 0s; }
        .monomer:nth-child(2) { animation-delay: 0.2s; }
        .monomer:nth-child(3) { animation-delay: 0.4s; }
        .monomer:nth-child(4) { animation-delay: 0.6s; }
        .monomer:nth-child(5) { animation-delay: 0.8s; }

        /* Responsive Sidebar */
        @media (max-width: 768px) {
            .w-64 { width: 0 !important; }
            .md\:block { display: none !important; }
        }
        .sidebar {
            transition: var(--transition-standard);
            will-change: transform;
        }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 50;
                transform: translateX(-100%);
            }
            .sidebar.open {
                transform: translateX(0);
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.5);
                opacity: 0;
                pointer-events: none;
                transition: var(--transition-standard);
                z-index: 40;
                backdrop-filter: blur(4px);
                -webkit-backdrop-filter: blur(4px);
            }
            .sidebar-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }
        }

        /* Print Styles */
        @media print {
            body { background: none; }
            .sidebar, .loading-screen { display: none; }
            .simulation-container { box-shadow: none; }
            .quiz-option { border: 1px solid #000; }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, ::before, ::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body class="text-gray-800">
    <!-- Loading Screen -->
    <div class="loading-screen">
        <div class="polymer-loader">
            <div class="monomer"></div>
            <div class="monomer"></div>
            <div class="monomer"></div>
            <div class="monomer"></div>
            <div class="monomer"></div>
        </div>
        <h2 class="text-white text-2xl font-bold mt-8">Polymer Virtual Lab</h2>
        <p class="text-blue-100 mt-2">Loading simulation environment...</p>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Layout -->
    <div class="flex min-h-screen overflow-hidden">
        <!-- Sidebar -->
        <div class="sidebar w-64 bg-white shadow-lg z-10 flex-shrink-0 fixed md:relative h-full" id="sidebar">
            <div class="p-5 border-b flex justify-between items-center">
                <div>
                    <h1 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-flask mr-2 text-blue-500"></i>
                        Polymer Lab
                    </h1>
                    <p class="text-sm text-gray-600 mt-1">Virtual Simulation</p>
                </div>
                <button class="md:hidden text-gray-600 hover:text-gray-800 focus:outline-none" id="closeSidebar">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="mt-6">
                <a href="#" class="nav-link active block py-3 px-6 text-gray-700 hover:text-blue-600" data-section="introduction">
                    <i class="fas fa-home mr-3"></i> Introduction
                </a>
                <a href="#" class="nav-link block py-3 px-6 text-gray-700 hover:text-blue-600" data-section="types">
                    <i class="fas fa-project-diagram mr-3"></i> Polymer Types
                </a>
                <a href="#" class="nav-link block py-3 px-6 text-gray-700 hover:text-blue-600" data-section="structure">
                    <i class="fas fa-atom mr-3"></i> Structure Viewer
                </a>
                <a href="#" class="nav-link block py-3 px-6 text-gray-700 hover:text-blue-600" data-section="properties">
                    <i class="fas fa-weight-hanging mr-3"></i> Physical Properties
                </a>
                <a href="#" class="nav-link block py-3 px-6 text-gray-700 hover:text-blue-600" data-section="quiz">
                    <i class="fas fa-question-circle mr-3"></i> Quiz/Test Yourself
                </a>
            </nav>
            <div class="absolute bottom-0 w-full p-4 border-t">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm font-medium">Progress</p>
                        <div class="progress-bar w-full mt-1">
                            <div class="progress-fill"></div>
                        </div>
                    </div>
                    <button class="bg-gray-100 p-2 rounded-full text-gray-600 hover:bg-gray-200">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col w-full">
            <!-- Mobile Header -->
            <header class="bg-white shadow md:hidden">
                <div class="p-4 flex items-center justify-between">
                    <div>
                        <h1 class="text-lg font-bold text-gray-800">Polymer Lab</h1>
                        <p class="text-xs text-gray-600">Virtual Simulation</p>
                    </div>
                    <button id="openSidebar" class="text-gray-600 hover:text-gray-800 focus:outline-none">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
                <div id="mobile-nav" class="hidden border-t">
                    <nav class="flex overflow-x-auto py-2 px-4 space-x-4">
                        <a href="#" class="whitespace-nowrap px-3 py-2 text-sm font-medium text-blue-600 border-b-2 border-blue-600" data-section="introduction">
                            <i class="fas fa-home mr-2"></i>Introduction
                        </a>
                        <a href="#" class="whitespace-nowrap px-3 py-2 text-sm font-medium text-gray-600" data-section="types">
                            <i class="fas fa-project-diagram mr-2"></i>Types
                        </a>
                        <a href="#" class="whitespace-nowrap px-3 py-2 text-sm font-medium text-gray-600" data-section="structure">
                            <i class="fas fa-atom mr-2"></i>Structure
                        </a>
                        <a href="#" class="whitespace-nowrap px-3 py-2 text-sm font-medium text-gray-600" data-section="properties">
                            <i class="fas fa-weight-hanging mr-2"></i>Properties
                        </a>
                        <a href="#" class="whitespace-nowrap px-3 py-2 text-sm font-medium text-gray-600" data-section="quiz">
                            <i class="fas fa-question-circle mr-2"></i>Quiz
                        </a>
                    </nav>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto p-4 md:p-6 w-full">
                <div class="max-w-7xl mx-auto space-y-6">
                    <!-- Header -->
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800">Polymer Structure and Properties</h1>
                        <p class="text-gray-600 mt-2">Explore the molecular structure of polymers and their physical properties through interactive simulation</p>
                    </div>
                    
                    <!-- Introduction Section -->
                    <div id="introduction-section" class="hidden">
                        <div class="bg-white rounded-xl shadow p-6 space-y-6">
                            <div>
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-graduation-cap text-blue-500 mr-2"></i>
                                    Learning Objectives
                            </h2>
                                <ul class="list-disc pl-6 space-y-2 text-gray-700">
                                    <li>Understand addition and condensation polymerization mechanisms</li>
                                    <li>Explore polymer structures: linear, branched, and cross-linked</li>
                                    <li>Learn how monomers, initiators, and temperature affect polymer properties</li>
                                    <li>Measure and interpret physical properties: Tg, Tm, tensile strength</li>
                                    <li>Visualize real-time changes through interactive 3D models and data plots</li>
                                </ul>
                    </div>

                            <div>
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                    <i class="fas fa-atom text-blue-500 mr-2"></i>
                                    Polymerization Mechanisms
                            </h2>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-blue-800 mb-2">Addition Polymerization</h3>
                                        <ul class="space-y-2 text-gray-700">
                                            <li>• Monomers join via free radical mechanisms</li>
                                            <li>• Temperature and initiators control rate</li>
                                            <li>• Examples: ethylene, styrene polymerization</li>
                            </ul>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg">
                                        <h3 class="font-semibold text-green-800 mb-2">Condensation Polymerization</h3>
                                        <ul class="space-y-2 text-gray-700">
                                            <li>• Involves dicarboxylic acids + diols</li>
                                            <li>• Releases water during reaction</li>
                                            <li>• Forms esters or amides</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Types Section -->
                    <div id="types-section" class="hidden">
                        <div class="bg-white rounded-xl shadow p-6 space-y-6">
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-blue-800 mb-2">Linear Polymers</h3>
                                    <ul class="space-y-2 text-gray-700">
                                        <li>• High density and crystallinity</li>
                                        <li>• Good tensile strength</li>
                                        <li>• Example: HDPE bottles</li>
                                    </ul>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-green-800 mb-2">Branched Polymers</h3>
                                    <ul class="space-y-2 text-gray-700">
                                        <li>• Lower density</li>
                                        <li>• More flexible structure</li>
                                        <li>• Example: LDPE bags</li>
                                    </ul>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg">
                                    <h3 class="font-semibold text-purple-800 mb-2">Cross-linked Polymers</h3>
                                    <ul class="space-y-2 text-gray-700">
                                        <li>• High rigidity</li>
                                        <li>• Excellent thermal stability</li>
                                        <li>• Example: Epoxy resins</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Structure Viewer Section -->
                    <div id="structure-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="simulation-container h-full">
                                <!-- Polymerization Equation -->
                                <div class="bg-gray-50 p-4 border-b text-center">
                                    <p class="text-lg font-mono" id="polymerization-equation">
                                        nCH₂=CH₂ → -(CH₂-CH₂)-n
                                    </p>
                                </div>
                                
                                <div id="polymerView" class="w-full h-96 md:h-[500px] bg-gray-50 relative"></div>
                                
                                <!-- Simulation Controls -->
                                <div class="bg-gray-50 p-4 border-t">
                                    <div class="flex flex-wrap items-center justify-between gap-3">
                                        <div class="flex gap-2">
                                            <button id="startBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center transition disabled:opacity-50 disabled:cursor-not-allowed">
                                                <i class="fas fa-play mr-2"></i> Start
                                            </button>
                                            <button id="pauseBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg flex items-center transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                                <i class="fas fa-pause mr-2"></i> Pause
                                            </button>
                                            <button id="resetBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg flex items-center transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                                <i class="fas fa-redo mr-2"></i> Reset
                                            </button>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label class="text-sm font-medium text-gray-700 mr-2">Polymer Type:</label>
                                            <select id="polymerType" class="border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                                                <option value="linear">Linear</option>
                                                <option value="branched">Branched</option>
                                                <option value="cross-linked">Cross-linked</option>
                                            </select>
                                            <label class="text-sm font-medium text-gray-700 ml-4">Monomer:</label>
                                            <select id="monomer" class="border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                                                <option value="ethylene">Ethylene</option>
                                                <option value="styrene">Styrene</option>
                                            </select>
                                            <label class="text-sm font-medium text-gray-700 ml-4">Initiator:</label>
                                            <select id="initiator" class="border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-300">
                                                <option value="peroxide">Peroxide</option>
                                                <option value="azo">Azo compound</option>
                                                <option value="redox">Redox system</option>
                                            </select>
                                            <label class="text-sm font-medium text-gray-700 ml-4">Temperature:</label>
                                            <input type="range" id="temperature" min="20" max="200" value="100" class="mx-2">
                                            <span id="tempValue" class="text-sm font-medium text-gray-700">100°C</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Information Panel -->
                        <div class="bg-white rounded-xl shadow p-5" id="polymer-info">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-info-circle text-blue-500 mr-2"></i>
                                Polymer Information
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-medium text-gray-700">Current Structure</h3>
                                    <p id="currentPolymer" class="text-blue-600 font-semibold">Linear Polymer</p>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-700">Characteristics</h3>
                                    <ul id="polymer-characteristics" class="list-disc pl-5 space-y-1 text-sm mt-1">
                                        <li>High density</li>
                                        <li>Good tensile strength</li>
                                        <li>Semi-crystalline</li>
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="font-medium text-gray-700">Common Applications</h3>
                                    <ul id="polymer-applications" class="list-disc pl-5 space-y-1 text-sm mt-1">
                                        <li>Plastic bottles</li>
                                        <li>Packaging films</li>
                                        <li>Textile fibers</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="mt-6">
                                <h3 class="font-medium text-gray-700 mb-2">Interactive Guide</h3>
                                <div class="bg-blue-50 rounded-lg p-3 text-sm">
                                    <p class="flex items-start">
                                        <i class="fas fa-mouse-pointer text-blue-500 mt-1 mr-2"></i>
                                        Hover over atoms to see detailed information
                                    </p>
                                    <p class="flex items-start mt-2">
                                        <i class="fas fa-rotate text-blue-500 mt-1 mr-2"></i>
                                        Click and drag to rotate the polymer structure
                                    </p>
                                    <p class="flex items-start mt-2">
                                        <i class="fas fa-up-right-and-down-left-from-center text-blue-500 mt-1 mr-2"></i>
                                        Scroll to zoom in and out
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Polymer Analysis Graphs -->
                        <div class="lg:col-span-3">
                            <div class="mt-6">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Polymer Analysis Graphs</h3>
                                <p class="text-gray-600 mb-6">These graphs provide real-time analysis of the polymerization process.</p>
                                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <div class="h-72"><canvas id="chainGrowthChart"></canvas></div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm">
                                        <div class="h-72"><canvas id="tempRateChart"></canvas></div>
                                    </div>
                                    <div class="bg-white p-4 rounded-lg border shadow-sm lg:col-span-2">
                                        <div class="h-72"><canvas id="tensileStrengthChart"></canvas></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Physical Properties Section -->
                    <div id="properties-section" class="hidden">
                        <div class="bg-white rounded-xl shadow p-6 space-y-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-weight-hanging text-blue-500 mr-2"></i>
                                Physical Properties
                            </h2>
                            <div class="grid md:grid-cols-3 gap-6">
                                <div class="property-card bg-blue-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                            <i class="fas fa-temperature-high text-blue-600"></i>
                                        </div>
                                        <h3 class="font-semibold text-blue-800">Glass Transition Temperature (Tg)</h3>
                                    </div>
                                    <p class="text-gray-700 text-sm mt-2">Temperature where the polymer transitions from hard to rubbery state.</p>
                                    <div class="mt-3 flex items-center justify-between">
                                        <span id="tg-value" class="text-blue-600 font-semibold">78°C</span>
                                        <button class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200" onclick="showPropertyInfo('tg')">
                                            Learn More
                                        </button>
                                    </div>
                                </div>
                                <div class="property-card bg-green-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <div class="bg-green-100 p-2 rounded-lg mr-3">
                                            <i class="fas fa-fire text-green-600"></i>
                                        </div>
                                        <h3 class="font-semibold text-green-800">Melting Point (Tm)</h3>
                                    </div>
                                    <p class="text-gray-700 text-sm mt-2">Above this temperature, crystalline regions melt. Affected by structure.</p>
                                    <div class="mt-3 flex items-center justify-between">
                                        <span id="tm-value" class="text-green-600 font-semibold">265°C</span>
                                        <button class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded hover:bg-green-200" onclick="showPropertyInfo('tm')">
                                            Learn More
                                        </button>
                                    </div>
                                </div>
                                <div class="property-card bg-purple-50 p-4 rounded-lg">
                                    <div class="flex items-center mb-2">
                                        <div class="bg-purple-100 p-2 rounded-lg mr-3">
                                            <i class="fas fa-ruler-combined text-purple-600"></i>
                                        </div>
                                        <h3 class="font-semibold text-purple-800">Tensile Strength</h3>
                                    </div>
                                    <p class="text-gray-700 text-sm mt-2">Maximum stress the polymer can withstand while being stretched.</p>
                                    <div class="mt-3 flex items-center justify-between">
                                        <span id="tensile-value" class="text-purple-600 font-semibold">55 MPa</span>
                                        <button class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded hover:bg-purple-200" onclick="showPropertyInfo('tensile')">
                                            Learn More
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Property Details Table -->
                            <div class="mt-8">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">Property Comparison by Structure</h3>
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Property</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Linear</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Branched</th>
                                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cross-linked</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Glass Transition (°C)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">78</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">65</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">95</td>
                                            </tr>
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Melting Point (°C)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">265</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">230</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">N/A</td>
                                            </tr>
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Tensile Strength (MPa)</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">55</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">35</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">80</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quiz Section -->
                    <div id="quiz-section" class="hidden">
                        <div class="bg-white rounded-xl shadow p-6 space-y-6">
                            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                                <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                                Quiz: Test Your Knowledge
                            </h2>
                            
                            <div class="space-y-8">
                                <!-- Question 1 -->
                                <div class="quiz-question bg-gray-50 p-6 rounded-lg">
                                    <p class="font-medium text-gray-800 mb-4">1. Which property is most affected by polymer branching?</p>
                                    <div class="grid grid-cols-1 gap-3">
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Density
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="true">
                                            Crystallinity
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Melting Point
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Tensile Strength
                                        </button>
                                    </div>
                                </div>

                                <!-- Question 2 -->
                                <div class="quiz-question bg-gray-50 p-6 rounded-lg">
                                    <p class="font-medium text-gray-800 mb-4">2. Which polymer type has the highest tensile strength?</p>
                                    <div class="grid grid-cols-1 gap-3">
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Linear
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Branched
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="true">
                                            Cross-linked
                                        </button>
                                        <button class="quiz-option bg-white border p-4 rounded-lg text-left hover:bg-blue-50 hover:border-blue-500 transition-colors" data-correct="false">
                                            Random
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8 flex flex-col items-center space-y-4">
                                <button id="submitQuiz" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white px-8 py-3 rounded-lg font-medium transition-colors">
                                    Submit Answers
                                </button>
                                <div id="quizResult" class="hidden text-center w-full">
                                    <p class="text-lg font-medium text-gray-800 mb-4"></p>
                                    <button id="retakeQuiz" class="text-blue-500 hover:text-blue-600 font-medium inline-flex items-center gap-2">
                                        <i class="fas fa-redo"></i>
                                        Retake Quiz
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Tooltip Container -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Help Button -->
    <button id="helpBtn" class="fixed top-4 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 focus:outline-none z-50">
        <i class="fas fa-question"></i>
    </button>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60]">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-6 max-w-lg w-full mx-4">
            <h3 class="text-xl font-bold mb-4">Welcome to the Polymer Virtual Lab!</h3>
            <div class="space-y-4 text-gray-600" id="tutorial-content">
                <!-- Tutorial steps will be inserted here by JavaScript -->
            </div>
            <div class="mt-6 flex justify-between">
                <button id="prevTutorial" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    <i class="fas fa-arrow-left mr-2"></i> Previous
                </button>
                <button id="nextTutorial" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Next <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script>
    // === Initialize State Object ===
    window.state = {
        // Three.js components
        scene: null,
        camera: null,
        renderer: null,
        controls: null,
        polymerGroup: null,
        polymerGroupCondensation: null,
        radicalGlow: null,
        
        // Simulation state
        waterMolecules: [],
        monomerPositions: [],
        crossLinkCount: 0,
        chainLength: 0,
        simRunning: false,
        simInterval: null,
        simulationStartTime: null,
        maxMonomers: 12,
        currentPolymerType: 'linear',
        currentMonomer: 'ethylene',
        
        // Charts
        chainGrowthChart: null,
        tempRateChart: null,
        tensileStrengthChart: null,
        
        // Quiz state
        quizSubmitted: false,
        
        // Constants
        atomColors: { C: 0x222222, H: 0xffffff, O: 0xff0000 },
        BOND_LENGTH: 1.5,
        BOND_ANGLE: Math.PI / 3,
        MAX_CROSS_LINKS: 4,
        
        // Polymer properties
        polymerProperties: {
            linear: {
                baseRate: 1.0,
                tensileStrength: 55,
                color: 'rgba(59, 130, 246, 0.7)', // blue
                equation: 'nCH₂=CH₂ → -(CH₂-CH₂)-n'
            },
            branched: {
                baseRate: 0.8,
                tensileStrength: 35,
                color: 'rgba(16, 185, 129, 0.7)', // green
                equation: 'nCH₂=CH₂ → -(CH₂-CH₂-CH₂)-n'
            },
            'cross-linked': {
                baseRate: 0.6,
                tensileStrength: 80,
                color: 'rgba(139, 92, 246, 0.7)', // purple
                equation: 'nCH₂=CH₂ + crosslinker → [-(CH₂-CH₂)-]n'
            }
        }
    };

    // === Helper Functions ===
    function getReactionRate(temperature, polymerType) {
        const baseRate = state.polymerProperties[polymerType].baseRate;
        // Arrhenius-like temperature dependence
        return baseRate * Math.exp((temperature - 100) / 50);
    }

    function createAtom(type, position) {
        const color = state.atomColors[type] || 0x888888;
        const radius = type === 'C' ? 0.7 : (type === 'H' ? 0.35 : 0.5);
        const geometry = new THREE.SphereGeometry(radius, 32, 32);
        const material = new THREE.MeshPhongMaterial({ color });
        const sphere = new THREE.Mesh(geometry, material);
        sphere.position.copy(position);
        sphere.userData.atomType = type;
        return sphere;
    }

    function createBond(start, end) {
        const dir = new THREE.Vector3().subVectors(end, start);
        const length = dir.length();
        const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
        const geometry = new THREE.CylinderGeometry(0.15, 0.15, length, 16);
        const material = new THREE.MeshPhongMaterial({ color: 0x888888 });
        const bond = new THREE.Mesh(geometry, material);
        bond.position.copy(mid);
        bond.lookAt(end);
        bond.rotateX(Math.PI / 2);
        return bond;
    }

    function createWaterMolecule(position) {
        const waterGroup = new THREE.Group();
        const oxygen = createAtom('O', new THREE.Vector3(0, 0, 0));
        waterGroup.add(oxygen);
        const h1 = createAtom('H', new THREE.Vector3(0.4, 0.3, 0));
        waterGroup.add(h1);
        const h2 = createAtom('H', new THREE.Vector3(-0.4, 0.3, 0));
        waterGroup.add(h2);
        waterGroup.add(createBond(oxygen.position, h1.position));
        waterGroup.add(createBond(oxygen.position, h2.position));
        waterGroup.position.copy(position);
        return waterGroup;
    }

    // === Animation Functions ===
    function animateWaterMolecules() {
        for (let i = state.waterMolecules.length - 1; i >= 0; i--) {
            const w = state.waterMolecules[i];
            w.mesh.position.add(w.velocity);
            w.velocity.y -= 0.001;
            if (w.mesh.position.y < -2) {
                state.polymerGroupCondensation.remove(w.mesh);
                state.waterMolecules.splice(i, 1);
            }
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        if (state.controls) state.controls.update();
        animateWaterMolecules();
        if (state.renderer && state.scene && state.camera) {
            state.renderer.render(state.scene, state.camera);
        }
    }

    // === Simulation State Management ===
    function clearPolymerGroups() {
        if (state.polymerGroup) {
            while (state.polymerGroup.children.length > 0) {
                state.polymerGroup.remove(state.polymerGroup.children[0]);
            }
        }
        if (state.radicalGlow) {
            state.polymerGroup.remove(state.radicalGlow);
            state.radicalGlow = null;
        }
        if (state.polymerGroupCondensation) {
            while (state.polymerGroupCondensation.children.length > 0) {
                state.polymerGroupCondensation.remove(state.polymerGroupCondensation.children[0]);
            }
        }
        state.waterMolecules = [];
        state.monomerPositions = [];
    }

    // === Monomer Addition Function ===
    function addMonomerAddition(idx, monomerType, structureType) {
        try {
            // Calculate base position with improved 3D structure
            const angle = (idx * Math.PI) / 6; // 30-degree rotation between monomers
            const radius = 2; // Distance from center
            const height = idx * 0.5; // Gradual height increase
            
            const basePosition = new THREE.Vector3(
                radius * Math.cos(angle),
                height,
                radius * Math.sin(angle)
            );
            
            // Store monomer position for potential cross-linking
            if (structureType === 'cross-linked') {
                state.monomerPositions.push({
                    position: basePosition.clone(),
                    index: idx
                });
            }
            
            if (monomerType === 'ethylene') {
                // Create main chain carbons
                const c1 = createAtom('C', basePosition);
                const c2Pos = basePosition.clone().add(new THREE.Vector3(state.BOND_LENGTH, 0, 0));
                const c2 = createAtom('C', c2Pos);
                state.polymerGroup.add(c1, c2);
                
                // Add hydrogens with tetrahedral geometry
                const h1Pos = basePosition.clone().add(new THREE.Vector3(0, state.BOND_LENGTH * Math.sin(state.BOND_ANGLE), 0));
                const h2Pos = basePosition.clone().add(new THREE.Vector3(0, -state.BOND_LENGTH * Math.sin(state.BOND_ANGLE), 0));
                const h3Pos = c2Pos.clone().add(new THREE.Vector3(0, state.BOND_LENGTH * Math.sin(state.BOND_ANGLE), 0));
                const h4Pos = c2Pos.clone().add(new THREE.Vector3(0, -state.BOND_LENGTH * Math.sin(state.BOND_ANGLE), 0));
                
                state.polymerGroup.add(createAtom('H', h1Pos));
                state.polymerGroup.add(createAtom('H', h2Pos));
                state.polymerGroup.add(createAtom('H', h3Pos));
                state.polymerGroup.add(createAtom('H', h4Pos));
                
                // Add bonds
                state.polymerGroup.add(createBond(basePosition, c2Pos));
                state.polymerGroup.add(createBond(basePosition, h1Pos));
                state.polymerGroup.add(createBond(basePosition, h2Pos));
                state.polymerGroup.add(createBond(c2Pos, h3Pos));
                state.polymerGroup.add(createBond(c2Pos, h4Pos));
                
                // Add bond to previous monomer if not first
                if (idx > 0) {
                    const prevAngle = ((idx - 1) * Math.PI) / 6;
                    const prevPos = new THREE.Vector3(
                        radius * Math.cos(prevAngle),
                        (idx - 1) * 0.5,
                        radius * Math.sin(prevAngle)
                    );
                    state.polymerGroup.add(createBond(prevPos.clone().add(new THREE.Vector3(state.BOND_LENGTH, 0, 0)), basePosition));
                }
                
                // Add branching if needed
                if (structureType === 'branched' && idx > 1 && idx % 3 === 0) {
                    const branchPos = basePosition.clone().add(new THREE.Vector3(0, state.BOND_LENGTH * 2, 0));
                    const branchC = createAtom('C', branchPos);
                    state.polymerGroup.add(branchC);
                    state.polymerGroup.add(createBond(basePosition, branchPos));
                    
                    // Add hydrogens to branch
                    const bh1Pos = branchPos.clone().add(new THREE.Vector3(state.BOND_LENGTH, 0, 0));
                    const bh2Pos = branchPos.clone().add(new THREE.Vector3(-state.BOND_LENGTH, 0, 0));
                    const bh3Pos = branchPos.clone().add(new THREE.Vector3(0, state.BOND_LENGTH, 0));
                    
                    state.polymerGroup.add(createAtom('H', bh1Pos));
                    state.polymerGroup.add(createAtom('H', bh2Pos));
                    state.polymerGroup.add(createAtom('H', bh3Pos));
                    
                    state.polymerGroup.add(createBond(branchPos, bh1Pos));
                    state.polymerGroup.add(createBond(branchPos, bh2Pos));
                    state.polymerGroup.add(createBond(branchPos, bh3Pos));
                }
                
                // Add cross-linking if needed
                if (structureType === 'cross-linked' && idx > 2 && idx % 4 === 0) {
                    const crossPos = basePosition.clone().add(new THREE.Vector3(0, -state.BOND_LENGTH * 2, 0));
                    const crossC = createAtom('C', crossPos);
                    state.polymerGroup.add(crossC);
                    state.polymerGroup.add(createBond(basePosition, crossPos));
                    
                    // Add hydrogens to cross-link
                    const ch1Pos = crossPos.clone().add(new THREE.Vector3(state.BOND_LENGTH, 0, 0));
                    const ch2Pos = crossPos.clone().add(new THREE.Vector3(-state.BOND_LENGTH, 0, 0));
                    
                    state.polymerGroup.add(createAtom('H', ch1Pos));
                    state.polymerGroup.add(createAtom('H', ch2Pos));
                    
                    state.polymerGroup.add(createBond(crossPos, ch1Pos));
                    state.polymerGroup.add(createBond(crossPos, ch2Pos));
                }
            } else if (monomerType === 'styrene') {
                // Create backbone carbon
                const backboneC = createAtom('C', basePosition);
                state.polymerGroup.add(backboneC);
                
                // Add phenyl ring
                const ringCenter = basePosition.clone().add(new THREE.Vector3(1.2, 1.2, 0));
                const phenylRing = createPhenylRing(ringCenter, new THREE.Vector3(0, 0, 1));
                state.polymerGroup.add(phenylRing);
                state.polymerGroup.add(createBond(basePosition, ringCenter));
                
                // Add bond to previous monomer if not first
                if (idx > 0) {
                    const prevAngle = ((idx - 1) * Math.PI) / 6;
                    const prevPos = new THREE.Vector3(
                        radius * Math.cos(prevAngle),
                        (idx - 1) * 0.5,
                        radius * Math.sin(prevAngle)
                    );
                    state.polymerGroup.add(createBond(prevPos, basePosition));
                }
            }
            
            // Add radical glow at chain end
            if (state.radicalGlow) state.polymerGroup.remove(state.radicalGlow);
            const glowGeo = new THREE.SphereGeometry(1.0, 24, 24);
            const glowMat = new THREE.MeshBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.5 });
            state.radicalGlow = new THREE.Mesh(glowGeo, glowMat);
            state.radicalGlow.position.copy(basePosition);
            state.polymerGroup.add(state.radicalGlow);
            
        } catch (error) {
            console.error('Error in addMonomerAddition:', error);
        }
    }

    // === Chart Update Functions ===
    function updateChainGrowthChart() {
        if (!state.simulationStartTime || !state.chainGrowthChart) return;
        
        const currentTime = (Date.now() - state.simulationStartTime) / 1000;
        state.chainGrowthChart.data.labels.push(currentTime.toFixed(1));
        state.chainGrowthChart.data.datasets[0].data.push(state.chainLength);
        
        if (state.chainGrowthChart.data.labels.length > 20) {
            state.chainGrowthChart.data.labels.shift();
            state.chainGrowthChart.data.datasets[0].data.shift();
        }
        
        state.chainGrowthChart.update('none');
    }

    function updateTempRateChart() {
        if (!state.tempRateChart || !state.simulationStartTime) return;
        
        if (state.chainLength === 5) {
            const temperature = parseInt(document.getElementById('temperature').value);
            const timeElapsed = (Date.now() - state.simulationStartTime) / 1000;
            const rate = 5 / timeElapsed;
            
            // Find the dataset index for the current polymer type
            const datasetIndex = state.currentPolymerType === 'linear' ? 0 : 
                               state.currentPolymerType === 'branched' ? 1 : 2;
            
            state.tempRateChart.data.datasets[datasetIndex].data.push({
                x: temperature,
                y: parseFloat(rate.toFixed(2))
            });
            state.tempRateChart.update();
        }
    }

    function updateTensileStrengthHighlight() {
        if (!state.tensileStrengthChart) return;
        
        const baseColors = [
            state.polymerProperties.linear.color,
            state.polymerProperties.branched.color,
            state.polymerProperties['cross-linked'].color
        ];
        
        state.tensileStrengthChart.data.datasets[0].backgroundColor = baseColors.map((color, index) => {
            const polymerTypes = ['linear', 'branched', 'cross-linked'];
            return polymerTypes[index] === state.currentPolymerType ? color : color.replace('0.7', '0.3');
        });
        
        state.tensileStrengthChart.update();
    }

    // === Tutorial System ===
    const tutorialSteps = [
        {
            title: "Welcome to the Polymer Virtual Lab!",
            content: "This interactive simulation helps you understand polymer structures and their properties. Let's get started!",
            highlight: null
        },
        {
            title: "Select Polymer Type",
            content: "Choose between linear, branched, or cross-linked polymers. Each type has unique properties and applications.",
            highlight: "#polymerType"
        },
        {
            title: "Choose Your Monomer",
            content: "Select the building block for your polymer. Different monomers lead to different polymer properties.",
            highlight: "#monomer"
        },
        {
            title: "Set Temperature",
            content: "Adjust the temperature to control the polymerization rate. Higher temperatures generally mean faster reactions!",
            highlight: "#temperature"
        },
        {
            title: "Start the Simulation",
            content: "Click Start to begin the polymerization process. Watch as monomers join together to form the polymer chain!",
            highlight: "#startBtn"
        },
        {
            title: "Explore the 3D Structure",
            content: "Click and drag to rotate the structure. Scroll to zoom in/out. Hover over atoms for details.",
            highlight: "#polymerView"
        },
        {
            title: "Monitor Growth",
            content: "Watch the real-time graphs showing chain growth and reaction rates.",
            highlight: "#chainGrowthChart"
        }
    ];

    let currentTutorialStep = 0;

    function showTutorial() {
        document.getElementById('tutorial-overlay').classList.remove('hidden');
        showTutorialStep(0);
    }

    function showTutorialStep(stepIndex) {
        const step = tutorialSteps[stepIndex];
        const content = document.getElementById('tutorial-content');
        content.innerHTML = `
            <h4 class="font-semibold mb-2">${step.title}</h4>
            <p>${step.content}</p>
        `;
        
        // Remove previous highlights
        document.querySelectorAll('.tutorial-highlight').forEach(el => el.remove());
        
        // Add new highlight if specified
        if (step.highlight) {
            const element = document.querySelector(step.highlight);
            if (element) {
                const rect = element.getBoundingClientRect();
                const highlight = document.createElement('div');
                highlight.className = 'tutorial-highlight absolute border-2 border-blue-500 bg-blue-100 bg-opacity-20 z-50 transition-all duration-300';
                highlight.style.top = `${rect.top - 4}px`;
                highlight.style.left = `${rect.left - 4}px`;
                highlight.style.width = `${rect.width + 8}px`;
                highlight.style.height = `${rect.height + 8}px`;
                document.body.appendChild(highlight);
            }
        }
        
        // Update navigation buttons
        document.getElementById('prevTutorial').style.visibility = stepIndex === 0 ? 'hidden' : 'visible';
        document.getElementById('nextTutorial').textContent = stepIndex === tutorialSteps.length - 1 ? 'Finish' : 'Next';
    }

    // === Event Listeners ===
    document.getElementById('helpBtn').addEventListener('click', showTutorial);

    document.getElementById('prevTutorial').addEventListener('click', () => {
        if (currentTutorialStep > 0) {
            currentTutorialStep--;
            showTutorialStep(currentTutorialStep);
        }
    });

    document.getElementById('nextTutorial').addEventListener('click', () => {
        if (currentTutorialStep < tutorialSteps.length - 1) {
            currentTutorialStep++;
            showTutorialStep(currentTutorialStep);
        } else {
            document.getElementById('tutorial-overlay').classList.add('hidden');
            document.querySelectorAll('.tutorial-highlight').forEach(el => el.remove());
        }
    });

    // === Initialization ===
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Initialize Three.js scene
            initThreeJS();
            
            // Initialize charts
            initCharts();
            
            // Setup tooltip interaction
            setupTooltipInteraction();
            
            // Show introduction section by default
            showSection('introduction');
            
            // Hide loading screen and show tutorial for new users
            setTimeout(() => {
                document.querySelector('.loading-screen').style.opacity = '0';
                document.querySelector('.loading-screen').style.visibility = 'hidden';

                // Force tutorial for new users
                if (!localStorage.getItem('tutorialShown')) {
                    showTutorial();
                    localStorage.setItem('tutorialShown', 'true');
                }
            }, 2000);
            
        } catch (error) {
            console.error('Initialization error:', error);
            document.querySelector('.loading-screen').innerHTML = `
                <div class="text-red-500 text-center p-4">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p>Failed to initialize simulation. Please refresh the page.</p>
                    <p class="text-sm mt-2">${error.message}</p>
                </div>
            `;
        }
    });

    // === Three.js Initialization ===
    function initThreeJS() {
        const container = document.getElementById('polymerView');
        if (!container) {
            console.error('Polymer view container not found');
            return;
        }
        
        try {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Initialize scene
            state.scene = new THREE.Scene();
            state.scene.background = new THREE.Color(0xe0f0ff);
            
            // Setup camera
            state.camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
            state.camera.position.set(0, 0, 40);
            
            // Setup renderer
            state.renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                preserveDrawingBuffer: true
            });
            state.renderer.setSize(width, height);
            state.renderer.setPixelRatio(window.devicePixelRatio);
            container.appendChild(state.renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            state.scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 10);
            state.scene.add(directionalLight);
            
            // Setup controls
            state.controls = new THREE.OrbitControls(state.camera, state.renderer.domElement);
            state.controls.enableDamping = true;
            state.controls.dampingFactor = 0.05;
            state.controls.minDistance = 10;
            state.controls.maxDistance = 100;
            
            // Create polymer groups
            state.polymerGroup = new THREE.Group();
            state.scene.add(state.polymerGroup);
            
            state.polymerGroupCondensation = new THREE.Group();
            state.scene.add(state.polymerGroupCondensation);
            
            // Start animation loop
            animate();
            
            // Setup responsive behavior
            window.addEventListener('resize', function() {
                const width = container.clientWidth;
                const height = container.clientHeight;
                state.camera.aspect = width / height;
                state.camera.updateProjectionMatrix();
                state.renderer.setSize(width, height);
            });

            console.log('Three.js scene initialized successfully');
            return true;
        } catch (error) {
            console.error('Error initializing Three.js scene:', error);
            return false;
        }
    }

    // === Chart Initialization ===
    function initCharts() {
        // Chain Growth Chart
        const chainGrowthCtx = document.getElementById('chainGrowthChart').getContext('2d');
        state.chainGrowthChart = new Chart(chainGrowthCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Chain Length',
                    data: [],
                    borderColor: state.polymerProperties[state.currentPolymerType].color,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                animation: {
                    duration: 0
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Monomers'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time (s)'
                        }
                    }
                }
            }
        });
        
        // Temperature vs Rate Chart
        const tempRateCtx = document.getElementById('tempRateChart').getContext('2d');
        state.tempRateChart = new Chart(tempRateCtx, {
            type: 'scatter',
            data: {
                datasets: [
                    {
                        label: 'Linear',
                        data: [],
                        borderColor: state.polymerProperties.linear.color,
                        backgroundColor: state.polymerProperties.linear.color
                    },
                    {
                        label: 'Branched',
                        data: [],
                        borderColor: state.polymerProperties.branched.color,
                        backgroundColor: state.polymerProperties.branched.color
                    },
                    {
                        label: 'Cross-linked',
                        data: [],
                        borderColor: state.polymerProperties['cross-linked'].color,
                        backgroundColor: state.polymerProperties['cross-linked'].color
                    }
                ]
            },
            options: {
                responsive: true,
                animation: {
                    duration: 0
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Reaction Rate (monomers/s)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Temperature (°C)'
                        }
                    }
                }
            }
        });
        
        // Tensile Strength Chart
        const tensileStrengthCtx = document.getElementById('tensileStrengthChart').getContext('2d');
        state.tensileStrengthChart = new Chart(tensileStrengthCtx, {
            type: 'bar',
            data: {
                labels: ['Linear', 'Branched', 'Cross-linked'],
                datasets: [{
                    label: 'Tensile Strength (MPa)',
                    data: [
                        state.polymerProperties.linear.tensileStrength,
                        state.polymerProperties.branched.tensileStrength,
                        state.polymerProperties['cross-linked'].tensileStrength
                    ],
                    backgroundColor: [
                        state.polymerProperties.linear.color,
                        state.polymerProperties.branched.color,
                        state.polymerProperties['cross-linked'].color
                    ]
                }]
            },
            options: {
                responsive: true,
                animation: {
                    duration: 500
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Tensile Strength (MPa)'
                        }
                    }
                }
            }
        });
    }

    // === Tooltip Interaction ===
    function setupTooltipInteraction() {
        const tooltip = document.getElementById('tooltip');
        if (!tooltip || !state.renderer || !state.camera || !state.polymerGroup) return;
        
        const atomInfo = {
            C: 'Carbon atom: Forms the backbone of the polymer chain',
            H: 'Hydrogen atom: Attached to carbon atoms',
            O: 'Oxygen atom: Present in some functional groups',
            monomer: 'Monomer unit: Basic building block of the polymer'
        };
        
        state.renderer.domElement.addEventListener('mousemove', function(e) {
            const rect = state.renderer.domElement.getBoundingClientRect();
            const mouse = new THREE.Vector2(
                ((e.clientX - rect.left) / rect.width) * 2 - 1,
                -((e.clientY - rect.top) / rect.height) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, state.camera);
            
            const intersects = raycaster.intersectObjects(state.polymerGroup.children, true);
            if (intersects.length > 0 && intersects[0].object.userData.atomType) {
                const atomType = intersects[0].object.userData.atomType;
                tooltip.innerHTML = atomInfo[atomType] || atomInfo['monomer'];
                tooltip.style.opacity = '1';
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            } else {
                tooltip.style.opacity = '0';
            }
        });
        
        state.renderer.domElement.addEventListener('mouseleave', function() {
            tooltip.style.opacity = '0';
        });
    }

    // === Navigation Functions ===
    function showSection(section) {
        // Remove active state from all sidebar links
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.querySelectorAll('#mobile-nav a').forEach(link => link.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600'));
        
        // Highlight the clicked link
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.dataset.section === section) link.classList.add('active');
        });
        document.querySelectorAll('#mobile-nav a').forEach(link => {
            if (link.dataset.section === section) {
                link.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
                link.classList.remove('text-gray-600');
            }
        });
        
        // Hide all sections first
        ['introduction', 'types', 'structure', 'properties', 'quiz'].forEach(s => {
            const element = document.getElementById(s + '-section');
            if (element) {
                element.style.display = 'none';
            }
        });
        
        // Show the selected section
        const selectedSection = document.getElementById(section + '-section');
        if (selectedSection) {
            selectedSection.style.display = 'block';
        }
        
        // Structure section should be visible in all sections except introduction and quiz
        if (section !== 'introduction' && section !== 'quiz') {
            document.getElementById('structure-section').style.display = 'block';
        }
        
        // Close mobile menu if open
        const mobileNav = document.getElementById('mobile-nav');
        if (mobileNav) {
            mobileNav.classList.add('hidden');
        }
    }

    // === Event Listeners for Navigation ===
    // Sidebar navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            showSection(this.dataset.section);
        });
    });

    // Mobile navigation
    document.querySelectorAll('#mobile-nav a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            showSection(this.dataset.section);
        });
    });

    // Mobile menu toggle
    document.getElementById('openSidebar').addEventListener('click', function() {
        document.getElementById('mobile-nav').classList.toggle('hidden');
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', function(e) {
        const mobileNav = document.getElementById('mobile-nav');
        const openSidebarBtn = document.getElementById('openSidebar');
        
        if (!mobileNav.contains(e.target) && !openSidebarBtn.contains(e.target) && !mobileNav.classList.contains('hidden')) {
            mobileNav.classList.add('hidden');
        }
    });

    // === Simulation Control Functions ===
    function startSimulation() {
        if (state.simRunning) return;
        
        // Get current parameters
        const temperature = parseInt(document.getElementById('temperature').value);
        const initiator = document.getElementById('initiator').value;
        
        // Validate parameters
        if (!initiator) {
            alert('Please select an initiator.');
            return;
        }
        if (temperature < 50) {
            alert('Temperature too low. Raise above 50°C to initiate.');
            return;
        }
        
        try {
            // Clear previous polymer
            clearPolymerGroups();
            
            // Reset state
            state.chainLength = 0;
            state.simRunning = true;
            state.simulationStartTime = Date.now();
            state.crossLinkCount = 0;
            
            // Reset charts
            if (state.chainGrowthChart) {
                state.chainGrowthChart.data.labels = [];
                state.chainGrowthChart.data.datasets[0].data = [];
                state.chainGrowthChart.update();
            }
            
            // Update polymerization equation
            document.getElementById('polymerization-equation').textContent = 
                state.polymerProperties[state.currentPolymerType].equation;
            
            // Start polymerization
            if (state.currentPolymerType === 'linear' || 
                state.currentPolymerType === 'branched' || 
                state.currentPolymerType === 'cross-linked') {
                
                addMonomerAddition(state.chainLength, state.currentMonomer, state.currentPolymerType);
                state.chainLength++;
                
                state.simInterval = setInterval(() => {
                    if (state.chainLength >= state.maxMonomers) {
                        stopSimulation();
                        return;
                    }
                    addMonomerAddition(state.chainLength, state.currentMonomer, state.currentPolymerType);
                    state.chainLength++;
                    
                    // Update charts
                    updateChainGrowthChart();
                    updateTempRateChart();
                }, 700);
            }
            
            // Update button states
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resetBtn').disabled = false;
            
        } catch (error) {
            console.error('Error starting simulation:', error);
            stopSimulation();
        }
    }

    function stopSimulation() {
        if (!state.simRunning) return;
        state.simRunning = false;
        if (state.simInterval) {
            clearInterval(state.simInterval);
            state.simInterval = null;
        }
        
        // Update button states
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('resetBtn').disabled = false;
    }

    function resetSimulation() {
        stopSimulation();
        clearPolymerGroups();
        state.chainLength = 0;
        state.crossLinkCount = 0;
        
        // Reset charts
        if (state.chainGrowthChart) {
            state.chainGrowthChart.data.labels = [];
            state.chainGrowthChart.data.datasets[0].data = [];
            state.chainGrowthChart.update();
        }
        
        // Reset polymerization equation
        document.getElementById('polymerization-equation').textContent = 
            state.polymerProperties[state.currentPolymerType].equation;
        
        // Update button states
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('resetBtn').disabled = true;
    }

    // === Event Listeners for Controls ===
    document.getElementById('startBtn').addEventListener('click', startSimulation);
    document.getElementById('pauseBtn').addEventListener('click', stopSimulation);
    document.getElementById('resetBtn').addEventListener('click', resetSimulation);

    document.getElementById('temperature').addEventListener('input', function() {
        const temp = this.value;
        document.getElementById('tempValue').textContent = temp + '°C';
        
        // Show temperature guidance
        if (temp < 50) {
            document.getElementById('tempValue').className = 'text-sm font-medium text-red-600';
            document.getElementById('tempValue').textContent = temp + '°C (Too low)';
        } else if (temp > 150) {
            document.getElementById('tempValue').className = 'text-sm font-medium text-orange-600';
            document.getElementById('tempValue').textContent = temp + '°C (Very high)';
        } else {
            document.getElementById('tempValue').className = 'text-sm font-medium text-green-600';
            document.getElementById('tempValue').textContent = temp + '°C (Optimal)';
        }
    });

    // Polymer type change
    document.getElementById('polymerType').addEventListener('change', function() {
        state.currentPolymerType = this.value;
        
        // Update info panel
        const data = state.polymerProperties[this.value];
        document.getElementById('currentPolymer').textContent = 
            this.value.charAt(0).toUpperCase() + this.value.slice(1) + ' Polymer';
        
        // Update polymerization equation
        document.getElementById('polymerization-equation').textContent = data.equation;
        
        // Update chart colors
        if (state.chainGrowthChart) {
            state.chainGrowthChart.data.datasets[0].borderColor = data.color;
            state.chainGrowthChart.update();
        }
        
        updateTensileStrengthHighlight();
        resetSimulation();
    });

    // Monomer change
    document.getElementById('monomer').addEventListener('change', function() {
        state.currentMonomer = this.value;
        resetSimulation();
    });

    // === Property Information Functions ===
    const propertyInfo = {
        tg: {
            title: 'Glass Transition Temperature (Tg)',
            description: 'The temperature at which a polymer transitions from a hard, glassy state to a soft, rubbery state. This property is crucial for determining the polymer\'s working temperature range.',
            effects: {
                linear: 'Moderate Tg due to regular chain packing',
                branched: 'Lower Tg due to reduced chain interactions',
                'cross-linked': 'Higher Tg due to restricted chain movement'
            }
        },
        tm: {
            title: 'Melting Point (Tm)',
            description: 'The temperature at which the crystalline regions of the polymer melt. Cross-linked polymers typically don\'t have a true melting point as they decompose before melting.',
            effects: {
                linear: 'High Tm due to efficient crystal packing',
                branched: 'Lower Tm due to disrupted crystallinity',
                'cross-linked': 'No true melting point'
            }
        },
        tensile: {
            title: 'Tensile Strength',
            description: 'The maximum stress that a polymer can withstand while being stretched before failure. This property is directly related to the polymer\'s molecular structure and degree of crystallinity.',
            effects: {
                linear: 'Good strength due to chain alignment',
                branched: 'Lower strength due to irregular packing',
                'cross-linked': 'Highest strength due to covalent bonds'
            }
        }
    };

    function showPropertyInfo(property) {
        const info = propertyInfo[property];
        const content = `
            <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">${info.title}</h3>
                <p class="text-gray-700 mb-4">${info.description}</p>
                <div class="space-y-3">
                    <h4 class="font-semibold text-gray-800">Effects by Structure:</h4>
                    <div class="grid gap-2">
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                            <span class="text-sm">Linear: ${info.effects.linear}</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                            <span class="text-sm">Branched: ${info.effects.branched}</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-3 h-3 rounded-full bg-purple-500 mr-2"></div>
                            <span class="text-sm">Cross-linked: ${info.effects['cross-linked']}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-xl max-w-lg w-full mx-4 relative">
                <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-700" onclick="this.closest('.fixed').remove()">
                    <i class="fas fa-times"></i>
                </button>
                ${content}
                </div>
            `;
        document.body.appendChild(modal);
    }

    // Update property values based on polymer type
    function updatePropertyValues() {
        const properties = state.polymerProperties[state.currentPolymerType];
        document.getElementById('tensile-value').textContent = properties.tensileStrength + ' MPa';
        
        // Update other properties based on type
        if (state.currentPolymerType === 'linear') {
            document.getElementById('tg-value').textContent = '78°C';
            document.getElementById('tm-value').textContent = '265°C';
        } else if (state.currentPolymerType === 'branched') {
            document.getElementById('tg-value').textContent = '65°C';
            document.getElementById('tm-value').textContent = '230°C';
        } else {
            document.getElementById('tg-value').textContent = '95°C';
            document.getElementById('tm-value').textContent = 'N/A';
        }
    }

    // === Quiz Functions ===
    document.addEventListener('DOMContentLoaded', function() {
        // Quiz option selection
        document.querySelectorAll('.quiz-option').forEach(button => {
            button.addEventListener('click', () => {
                if (state.quizSubmitted) return;
                
                const questionDiv = button.closest('.quiz-question');
                const options = questionDiv.querySelectorAll('.quiz-option');
                
                // Remove selection from other options in the same question
                options.forEach(opt => opt.classList.remove('selected'));
                
                // Select this option
                button.classList.add('selected');
            });
        });

        // Submit quiz
        document.getElementById('submitQuiz').addEventListener('click', () => {
            const questions = document.querySelectorAll('.quiz-question');
            let correctAnswers = 0;
            let totalQuestions = questions.length;
            let allAnswered = true;

            questions.forEach(question => {
                const selected = question.querySelector('.quiz-option.selected');
                if (!selected) {
                    allAnswered = false;
                    return;
                }

                const allOptions = question.querySelectorAll('.quiz-option');
                allOptions.forEach(opt => {
                    opt.disabled = true;
                    if (opt.getAttribute('data-correct') === 'true') {
                        opt.classList.add('correct');
                    } else if (opt === selected && opt.getAttribute('data-correct') !== 'true') {
                        opt.classList.add('incorrect');
                    }
                });

                if (selected.getAttribute('data-correct') === 'true') {
                    correctAnswers++;
                }
            });

            if (!allAnswered) {
                alert('Please answer all questions before submitting.');
                return;
            }

            const resultDiv = document.getElementById('quizResult');
            resultDiv.classList.remove('hidden');
            resultDiv.querySelector('p').textContent = `You got ${correctAnswers} out of ${totalQuestions} correct!`;
            document.getElementById('submitQuiz').style.display = 'none';
            state.quizSubmitted = true;
        });

        // Retake quiz
        document.getElementById('retakeQuiz').addEventListener('click', () => {
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected', 'correct', 'incorrect');
            });
            document.getElementById('quizResult').classList.add('hidden');
            document.getElementById('submitQuiz').style.display = 'block';
            state.quizSubmitted = false;
        });
    });

    // Update properties when polymer type changes
    document.getElementById('polymerType').addEventListener('change', function() {
        updatePropertyValues();
    });
    </script>
</body>
</html>
